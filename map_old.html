<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dialysis Journey Map</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    nav { text-align: center; padding: 1em; background: #f8f8f8; }
    nav a { margin: 0 1em; text-decoration: none; }
    #map { position: fixed; top: 0; bottom: 0; width: 100%; }
    .floating-text-box {
      position: fixed;
      top: 10%;
      right: 5%;
      width: 30%;
      background: rgba(255,255,255,0.9);
      padding: 1.5rem;
      border-radius: 10px;
      z-index: 10;
    }
    .content { position: relative; z-index: 1; margin-top: 100vh; padding: 2rem; width: 60%; margin-left: auto; margin-right: auto; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Intro</a> |
    <a href="scrollytelling.html">Interactive Story</a> |
    <a href="map.html">Map</a>
  </nav>

  <div id="map"></div>
  <div class="floating-text-box" id="floatingText">
    <h2>Dialysis Journey</h2>
    <p>Scroll down to see patients traveling to treatment.</p>
  </div>

  <div class="content">
    <section><h3>Outbound Trip</h3><p>Patients leave Tillamook...</p></section>
    <section><h3>Treatment Pause</h3><p>Dialysis sessions take time...</p></section>
    <section><h3>Return Trip</h3><p>Patients return to Tillamook...</p></section>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2Fycmllcm9iaW4iLCJhIjoiY21jM2ltdTlyMDU1NTJrb2ZnMnFiazRqeiJ9.RT-SWZnQIo_Z7zSOdRh_vg';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-123.0, 45.6],
      zoom: 8.3,
      interactive: false
    });

    const tillamook = [-123.84668, 45.4561];
    const lincolnCityRoute = [tillamook, [-123.8, 45.3], [-123.75, 45.15], [-123.95, 44.96]];
    const astoriaRoute = [tillamook, [-123.85, 45.6], [-123.9, 45.75], [-123.83, 46.19]];

    const markerLincoln = new mapboxgl.Marker({ color: 'orange' }).setLngLat(tillamook).addTo(map);
    const markerAstoria = new mapboxgl.Marker({ color: 'blue' }).setLngLat(tillamook).addTo(map);

    function interpolate(coords, progress) {
      if (progress <= 0) return coords[0];
      if (progress >= 1) return coords[coords.length - 1];
      const i = Math.floor(progress * (coords.length - 1));
      const t = (progress * (coords.length - 1)) - i;
      const [aLng, aLat] = coords[i];
      const [bLng, bLat] = coords[i + 1];
      return [aLng + (bLng - aLng) * t, aLat + (bLat - aLat) * t];
    }

    const scrollStart = window.innerHeight * 0.5;
    const outboundLength = window.innerHeight * 2;
    const pauseLength = window.innerHeight * 1.5;
    const returnLength = window.innerHeight * 2;

    window.addEventListener('scroll', () => {
      const scrollY = window.scrollY;
      const progressOut = Math.min(Math.max((scrollY - scrollStart) / outboundLength, 0), 1);
      const progressBack = Math.min(Math.max((scrollY - (scrollStart + outboundLength + pauseLength)) / returnLength, 0), 1);

      if (scrollY < scrollStart) {
        markerLincoln.setLngLat(tillamook);
        markerAstoria.setLngLat(tillamook);
        document.getElementById('floatingText').innerHTML = `<h2>Dialysis Journey</h2><p>Scroll down to see patients traveling to treatment.</p>`;
      }
      else if (scrollY < scrollStart + outboundLength) {
        markerLincoln.setLngLat(interpolate(lincolnCityRoute, progressOut));
        markerAstoria.setLngLat(interpolate(astoriaRoute, progressOut));
        document.getElementById('floatingText').innerHTML = `<h2>Outbound</h2><p>Patients are heading to dialysis clinics. ${(progressOut*100).toFixed(0)}% complete.</p>`;
      }
      else if (scrollY < scrollStart + outboundLength + pauseLength) {
        markerLincoln.setLngLat(lincolnCityRoute[lincolnCityRoute.length - 1]);
        markerAstoria.setLngLat(astoriaRoute[astoriaRoute.length - 1]);
        document.getElementById('floatingText').innerHTML = `<h2>Treatment</h2><p>Patients are receiving dialysis. Scroll down to see their return.</p>`;
      }
      else if (scrollY < scrollStart + outboundLength + pauseLength + returnLength) {
        markerLincoln.setLngLat(interpolate(lincolnCityRoute.slice().reverse(), progressBack));
        markerAstoria.setLngLat(interpolate(astoriaRoute.slice().reverse(), progressBack));
        document.getElementById('floatingText').innerHTML = `<h2>Return Trip</h2><p>Heading back to Tillamook. ${(progressBack*100).toFixed(0)}% complete.</p>`;
      } else {
        markerLincoln.setLngLat(tillamook);
        markerAstoria.setLngLat(tillamook);
        document.getElementById('floatingText').innerHTML = `<h2>Home</h2><p>The long round-trip journey is complete.</p>`;
      }
    });
  </script>
</body>
</html>
